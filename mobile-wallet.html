<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Trust Wallet - Mobile</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }
        
        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            padding: 20px;
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .logo {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .subtitle {
            opacity: 0.8;
            font-size: 0.9rem;
        }
        
        .main-content {
            flex: 1;
            padding: 20px;
        }
        
        .scanner-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px 20px;
            text-align: center;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .scanner-frame {
            width: 250px;
            height: 250px;
            background: #000;
            border-radius: 15px;
            margin: 20px auto;
            position: relative;
            overflow: hidden;
        }
        
        #reader {
            width: 100%;
            height: 100%;
        }
        
        .scanner-placeholder {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: white;
        }
        
        .scanner-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }
        
        .controls {
            margin: 20px 0;
        }
        
        .btn {
            background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px;
            min-width: 150px;
            transition: transform 0.2s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            opacity: 0.5;
            transform: none;
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .result-section {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }
        
        .result-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #10B981;
        }
        
        .result-content {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .auth-steps {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .step {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        
        .step-icon {
            font-size: 1.5rem;
            margin-right: 15px;
            width: 40px;
        }
        
        .step-completed {
            background: rgba(16, 185, 129, 0.2);
        }
        
        .instructions {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .instructions h3 {
            margin-bottom: 10px;
        }
        
        .instructions p {
            line-height: 1.5;
            opacity: 0.9;
        }
        
        .demo-link {
            background: rgba(255, 165, 0, 0.2);
            border: 1px solid rgba(255, 165, 0, 0.4);
            border-radius: 15px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
        }
        
        .demo-link a {
            color: #FFA500;
            text-decoration: none;
            font-weight: bold;
        }
        
        @media (max-width: 480px) {
            .scanner-frame {
                width: 200px;
                height: 200px;
            }
            
            .btn {
                min-width: 120px;
                padding: 12px 20px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <div class="logo">üîê Trust Wallet</div>
            <div class="subtitle">Decentralized Identity Authentication</div>
        </div>
        
        <div class="main-content">
            <div class="demo-link">
                <a href="http://localhost:5174" target="_blank">üè¢ Open Portal (Generate QR Code)</a>
            </div>
            
            <div class="scanner-section">
                <h2>üì± QR Code Scanner</h2>
                <p>Scan authentication requests from the portal</p>
                
                <div class="scanner-frame">
                    <div id="reader"></div>
                    <div class="scanner-placeholder" id="placeholder">
                        <div class="scanner-icon">üì∑</div>
                        <div>Ready to Scan</div>
                    </div>
                </div>
                
                <div class="controls">
                    <button class="btn" id="startBtn">Start Camera</button>
                    <button class="btn btn-secondary" id="stopBtn" disabled>Stop Camera</button>
                </div>
                
                <div id="status">Tap "Start Camera" to begin scanning QR codes</div>
            </div>
            
            <div class="result-section" id="resultSection">
                <div class="result-title">üéâ Authentication Request Received!</div>
                <div class="result-content" id="resultContent"></div>
                <div class="controls">
                    <button class="btn">‚úÖ Authenticate</button>
                    <button class="btn btn-secondary">‚ùå Reject</button>
                </div>
            </div>
            
            <div class="auth-steps">
                <h3>üîÑ Authentication Flow</h3>
                <div class="step">
                    <div class="step-icon">üè¢</div>
                    <div>
                        <div><strong>Portal</strong></div>
                        <div>Generate QR authentication request</div>
                    </div>
                </div>
                <div class="step">
                    <div class="step-icon">üì±</div>
                    <div>
                        <div><strong>Mobile Wallet</strong></div>
                        <div>Scan QR code with this app</div>
                    </div>
                </div>
                <div class="step">
                    <div class="step-icon">üîê</div>
                    <div>
                        <div><strong>Zero-Knowledge Proof</strong></div>
                        <div>Verify identity without revealing data</div>
                    </div>
                </div>
                <div class="step">
                    <div class="step-icon">‚úÖ</div>
                    <div>
                        <div><strong>Access Granted</strong></div>
                        <div>Complete decentralized authentication</div>
                    </div>
                </div>
            </div>
            
            <div class="instructions">
                <h3>üìã How to Test</h3>
                <p>
                    1. Open the Portal link above<br>
                    2. Click "Login with DID Wallet"<br>
                    3. Return here and tap "Start Camera"<br>
                    4. Point your camera at the QR code<br>
                    5. Complete the authentication flow
                </p>
            </div>
        </div>
    </div>

    <script>
        let html5QrcodeScanner = null;
        let isScanning = false;
        
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const status = document.getElementById('status');
        const resultSection = document.getElementById('resultSection');
        const resultContent = document.getElementById('resultContent');
        const placeholder = document.getElementById('placeholder');
        
        // Check browser support
        function checkBrowserSupport() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                status.textContent = '‚ùå Camera not supported in this browser';
                startBtn.disabled = true;
                return false;
            }
            return true;
        }
        
        // Request camera permissions explicitly
        async function requestCameraPermission() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                stream.getTracks().forEach(track => track.stop()); // Stop the stream immediately
                return true;
            } catch (error) {
                console.error('Camera permission error:', error);
                status.textContent = '‚ùå Camera permission denied. Please allow camera access.';
                return false;
            }
        }
        
        function onScanSuccess(decodedText, decodedResult) {
            console.log('QR Scanned:', decodedText);
            
            try {
                const authData = JSON.parse(decodedText);
                
                if (authData.type === 'DID_AUTH_REQUEST') {
                    resultContent.textContent = JSON.stringify(authData, null, 2);
                    resultSection.style.display = 'block';
                    status.textContent = '‚úÖ Authentication request received!';
                    
                    // Simulate authentication steps
                    setTimeout(() => {
                        document.querySelectorAll('.step')[1].classList.add('step-completed');
                    }, 1000);
                    
                    setTimeout(() => {
                        document.querySelectorAll('.step')[2].classList.add('step-completed');
                    }, 2000);
                    
                    setTimeout(() => {
                        document.querySelectorAll('.step')[3].classList.add('step-completed');
                        status.textContent = 'üéâ Authentication completed successfully!';
                    }, 3000);
                } else {
                    resultContent.textContent = decodedText;
                    resultSection.style.display = 'block';
                    status.textContent = 'üìÑ QR code scanned';
                }
            } catch (e) {
                resultContent.textContent = decodedText;
                resultSection.style.display = 'block';
                status.textContent = 'üìÑ QR code scanned';
            }
        }
        
        function onScanFailure(error) {
            // Ignore continuous scan failures - too verbose
        }
        
        async function startScanning() {
            if (isScanning) return;
            
            if (!checkBrowserSupport()) return;
            
            status.textContent = 'üì∑ Requesting camera permission...';
            
            // Request permission first
            const hasPermission = await requestCameraPermission();
            if (!hasPermission) return;
            
            status.textContent = 'üì∑ Starting camera...';
            resultSection.style.display = 'none';
            
            try {
                html5QrcodeScanner = new Html5Qrcode("reader");
                
                const devices = await Html5Qrcode.getCameras();
                console.log('Available cameras:', devices);
                
                if (devices && devices.length) {
                    // Prefer back camera on mobile
                    let cameraId = devices[0].id;
                    for (let device of devices) {
                        if (device.label.toLowerCase().includes('back') || 
                            device.label.toLowerCase().includes('rear') ||
                            device.label.toLowerCase().includes('environment')) {
                            cameraId = device.id;
                            break;
                        }
                    }
                    
                    console.log('Using camera:', cameraId);
                    
                    await html5QrcodeScanner.start(
                        cameraId,
                        {
                            fps: 10,
                            qrbox: { width: 200, height: 200 },
                            aspectRatio: 1.0
                        },
                        onScanSuccess,
                        onScanFailure
                    );
                    
                    isScanning = true;
                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                    placeholder.style.display = 'none';
                    status.textContent = 'üì∑ Point camera at QR code';
                    document.querySelectorAll('.step')[0].classList.add('step-completed');
                    
                } else {
                    status.textContent = '‚ùå No camera found';
                }
            } catch (err) {
                console.error('Camera start error:', err);
                status.textContent = '‚ùå Camera error: ' + err.message;
                
                // More specific error messages
                if (err.name === 'NotAllowedError') {
                    status.textContent = '‚ùå Camera permission denied. Please allow camera access and try again.';
                } else if (err.name === 'NotFoundError') {
                    status.textContent = '‚ùå No camera found on this device.';
                } else if (err.name === 'NotSupportedError') {
                    status.textContent = '‚ùå Camera not supported in this browser.';
                }
            }
        }
        
        async function stopScanning() {
            if (!isScanning || !html5QrcodeScanner) return;
            
            try {
                await html5QrcodeScanner.stop();
                isScanning = false;
                startBtn.disabled = false;
                stopBtn.disabled = true;
                placeholder.style.display = 'flex';
                status.textContent = 'üì∑ Camera stopped';
            } catch (err) {
                console.error('Error stopping scanner:', err);
            }
        }
        
        startBtn.addEventListener('click', startScanning);
        stopBtn.addEventListener('click', stopScanning);
        
        // Initialize
        window.addEventListener('load', () => {
            checkBrowserSupport();
            
            // Auto-start camera on mobile after a delay
            if (/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                status.textContent = 'üì± Mobile detected - ready to scan!';
                setTimeout(() => {
                    status.textContent = 'Tap "Start Camera" to begin scanning';
                }, 2000);
            }
        });
        
        // Add debug info
        console.log('Browser User Agent:', navigator.userAgent);
        console.log('Has getUserMedia:', !!navigator.mediaDevices?.getUserMedia);
    </script>
</body>
</html>
